---
title: æ–°é—»æ¨èä¹‹æ¨èç³»ç»Ÿæµç¨‹çš„æ„å»º
date: 2021-12-30 14:22:35
tags: [æ¨èç³»ç»Ÿ]
categories: äººå·¥æ™ºèƒ½
widgets: null
password: 328
abstract: è¿™æ˜¯ä¸€ç¯‡åŠ å¯†åšæ–‡ï¼Œè¯·è¾“å…¥å¯†ç åæŸ¥çœ‹
message: è¿™é‡Œéœ€è¦å¯†ç æ‰èƒ½è®¿é—®ã€‚
wrong_pass_message: æŠ±æ­‰, è¿™ä¸ªå¯†ç çœ‹ç€ä¸å¤ªå¯¹, è¯·å†è¯•è¯•.

---

ä¼˜ç§€ä½œä¸šæ±‡æ€»ï¼š ã€Task01ã€‘

1. ä¸€èµ·å–å•¤é…’+S: https://seanlocked.github.io/#/news_rec_sys/task0/

2. PlayRec+èˆèˆ: https://andyguo.blog.csdn.net/article/details/121896008 ã€Task02ã€‘

3. PlayRec+èˆèˆ: https://andyguo.blog.csdn.net/article/details/121990657 ã€Task03ã€‘

4. JustForFun+é‡å®‰: https://blog.csdn.net/qq_43526989/article/details/122089453

5. JustForFun+æµ®å…‰æ å½±: https://blog.csdn.net/weixin_42917352/article/details/122097999 ã€Task04ã€‘

6. JustForFun+ä¼Šå°é›ªğŸŒ¸: https://blog.csdn.net/u012835414/article/details/122099857

7. PlayRec+èˆèˆ: https://andyguo.blog.csdn.net/article/details/122164752 ã€Task05ã€‘

8. JustForFun+å¤©å›½ä¹‹å½±: https://relph1119.github.io/my-team-learning/#/recommender_system32/task05

9. JustForFun+ä¼Šå°é›ªğŸŒ¸: https://blog.csdn.net/u012835414/article/details/122152312

10. ä¸€èµ·å–å•¤é…’+bamboo ğŸ‹: [https://github.com/comewei/study-in-graduate/blob/main/æ¨èç³»ç»Ÿæ‰“å¡/ç¬”è®°/DataWhale â€”â€” æ¨èç³»ç»Ÿå­¦ä¹ å››(æ¨èç³»ç»Ÿæµç¨‹çš„æ„å»º).md](https://github.com/comewei/study-in-graduate/blob/main/æ¨èç³»ç»Ÿæ‰“å¡/ç¬”è®°/DataWhale â€”â€” æ¨èç³»ç»Ÿå­¦ä¹ å››(æ¨èç³»ç»Ÿæµç¨‹çš„æ„å»º).md)

    

![](http://ryluo.oss-cn-chengdu.aliyuncs.com/å›¾ç‰‡Untitled.png)

æœ¬ç¯‡æ–‡ç« ä¸»è¦æ˜¯è®²è§£æ¨èç³»ç»Ÿæµç¨‹æ„å»ºï¼Œä¸»è¦åŒ…æ‹¬Offlineå’ŒOnlineä¸¤ä¸ªéƒ¨åˆ†ã€‚

# Offline

offlineéƒ¨åˆ†ä¸»è¦æ˜¯åŸºäºå‰é¢å­˜å‚¨å¥½çš„ç‰©æ–™ç”»åƒå’Œç”¨æˆ·ç”»åƒè¿›è¡Œç¦»çº¿è®¡ç®—ï¼Œ ä¸ºæ¯ä¸ªç”¨æˆ·æä¾›ä¸€ä¸ªçƒ­é—¨é¡µåˆ—è¡¨å’Œæ¨èé¡µåˆ—è¡¨å¹¶è¿›è¡Œç¼“å­˜ï¼Œ æ–¹ä¾¿onlineæœåŠ¡çš„åˆ—è¡¨è·å–ã€‚ æ‰€ä»¥ä¸‹é¢ä¸»è¦å¸®å¤§å®¶æ¢³ç†è¿™ä¸¤ä¸ªåˆ—è¡¨çš„ç”Ÿæˆä»¥åŠç¼“å­˜åˆ°redisçš„æµç¨‹ã€‚

## çƒ­é—¨é¡µåˆ—è¡¨

å½“ç”¨æˆ·è¿›å…¥ç³»ç»Ÿï¼Œ ç‚¹å‡»çƒ­é—¨æŒ‰é’®æ—¶ï¼Œ onlineæœåŠ¡å°±ä¼šä¸ºå½“å‰ç”¨æˆ·è·å–çƒ­é—¨é¡µåˆ—è¡¨ï¼Œ è€Œè¿™ä¸ªåˆ—è¡¨æ˜¯åœ¨ç”¨æˆ·ç™»å½•è¿›å…¥çš„æ—¶å€™ï¼Œ ç¦»çº¿éƒ¨åˆ†äº‹å…ˆä¸ºç”¨æˆ·ç”Ÿæˆå¥½ç¼“å­˜åˆ°äº†redisä¸­ã€‚onlineæœåŠ¡è·å–ï¼Œåªéœ€è¦ä»redisä¸­æ‹‰å–å³å¯ã€‚

æ‰€è°“çƒ­é—¨é¡µï¼Œ å°±æ˜¯å¯¹äºæ¯ç¯‡æ–‡ç« ï¼Œä¼šæ ¹æ®å®ƒçš„å‘å¸ƒæ—¶é—´ï¼Œç”¨æˆ·å¯¹å®ƒçš„è¡Œä¸ºè®°å½•(è·å¾—çš„ç‚¹èµæ•°ï¼Œæ”¶è—æ•°å’Œé˜…è¯»æ•°)å»è®¡ç®—è¯¥æ–‡ç« çš„çƒ­åº¦ä¿¡æ¯ï¼Œ ç„¶åæ ¹æ®çƒ­åº¦å€¼è¿›è¡Œæ’åºå¾—åˆ°ï¼Œ æ‰€ä»¥è®¡ç®—æ–‡ç« çš„çƒ­é—¨è®°å½•ï¼Œ åªéœ€è¦æ–‡ç« ç”»åƒçš„åŠ¨é™æ€ä¿¡æ¯å³å¯ï¼Œå¤©çº§æ›´æ–°ï¼Œ é€»è¾‘å¦‚ä¸‹:

æ¯å¤©å‡Œæ™¨ç‰©æ–™å¤„ç†å®Œï¼Œä¼šå¾—åˆ°æ¯ç¯‡æ–‡ç« çš„å‘å¸ƒæ—¶é—´(é™æ€ç‰¹å¾)ä»¥åŠæ¯ç¯‡æ–‡ç« ç›®å‰ä¸ºæ­¢ç´¯è®¡çš„è·èµæ•°ï¼Œè¢«æ”¶è—æ•°å’Œè¢«é˜…è¯»æ•°(åŠ¨æ€ç‰¹å¾)ï¼Œè¿™æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥éå†ç‰©æ–™æ± ä¸­çš„æ¯ç¯‡æ–‡ç« ï¼Œ æ‹¿åˆ°æ–‡ç« çš„å‘å¸ƒæ—¶é—´ï¼Œä¸å½“å‰æ—¶é—´ä½œå·®å¾—åˆ°æ–‡ç« çš„æ—¶æ•ˆæ€§ï¼Œç„¶åæ ¹æ®æ—¶æ•ˆæ€§è¿‡æ»¤æ‰å‘å¸ƒå¤ªä¹…çš„æ–‡ç« ï¼Œç„¶åå†ç»“åˆæ–‡ç« çš„åŠ¨æ€ç‰¹å¾ï¼ŒåŸºäºçƒ­åº¦å…¬å¼ï¼Œå°±èƒ½è®¡ç®—æ–‡ç« çš„çƒ­åº¦å€¼ã€‚æ¯ç¯‡æ–‡ç« éƒ½æœ‰ä¸€ä¸ªçƒ­åº¦å€¼ï¼Œæ ¹æ®çƒ­åº¦å€¼æ’åºï¼Œå°±å¯ä»¥å¾—åˆ°æ–‡ç« çƒ­é—¨åˆ—è¡¨ï¼ŒæŠŠè¯¥åˆ—è¡¨ä»¥zsetçš„å½¢å¼ç¼“å­˜åˆ°redisï¼Œä¹‹æ‰€ä»¥zsetï¼Œæ˜¯å› ä¸ºå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ ¹æ®hot valueè‡ªåŠ¨æ’å¥½åºã€‚  è¿™æ˜¯ä¸€ä»½å…¬å…±çš„çƒ­é—¨åˆ—è¡¨ï¼Œè¿™ä¸ªå¯ä»¥ä½œä¸ºæ¯ä¸ªç”¨æˆ·çƒ­é—¨åˆ—è¡¨çš„åˆå§‹åŒ–çŠ¶æ€ã€‚

ç”±äºæ¯ä¸ªç”¨æˆ·çš„å–œå¥½å…´è¶£ä¸åŒï¼Œå¯¹äºåŒä¸€ä¸ªçƒ­é—¨é¡µï¼Œç‚¹å‡»çš„æ–‡ç« å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒï¼Œè€Œæˆ‘ä»¬ç»™ç”¨æˆ·æ›å…‰çš„æ—¶å€™ï¼Œå¾€å¾€æ˜¯ä¼šå…ˆè¿‡æ»¤æ‰å¯¹ç”¨æˆ·æ›å…‰è¿‡çš„å†…å®¹ï¼Œæ‰€ä»¥ä¸ºäº†æ¯ä¸ªç”¨æˆ·çš„ä¸ªæ€§åŒ–æ›å…‰ï¼Œå½“ç”¨æˆ·ç™»å½•çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šç»™æ¯ä¸ªç”¨æˆ·å•ç‹¬ç”Ÿæˆä¸€ä¸ªçƒ­é—¨é¡µåˆ—è¡¨ï¼Œ åˆå§‹åŒ–çŠ¶æ€å°±æ˜¯ä¸Šé¢çš„å…¬å…±åˆ—è¡¨ã€‚ä¹‹åï¼Œç”¨æˆ·å†å»ç‚¹å‡»çƒ­é—¨çš„æ—¶å€™ï¼Œå°±ä»è‡ªå·±çš„çƒ­é—¨é¡µåˆ—è¡¨ä¸­è·å–æ–‡ç« äº†ï¼Œå½“ç„¶è¿™å—æ˜¯onlineæœåŠ¡ï¼Œ æˆ‘ä»¬æ”¾åé¢è¯¦ç»†è¯´ã€‚

æ‰€ä»¥ï¼Œç¦»çº¿çƒ­é—¨é¡µåˆ—è¡¨ç”Ÿæˆè¿‡ç¨‹æ€»ç»“èµ·æ¥ï¼Œå°±æ˜¯æ¯å¤©éå†ç‰©æ–™æ± ï¼Œ å¯¹äºæ¯ç¯‡æ–‡ç« ï¼ŒåŸºäºåŠ¨æ€ä¿¡æ¯å’Œé™æ€ç‰¹å¾è®¡ç®—çƒ­åº¦å€¼ï¼Œå¹¶è¿›è¡Œçƒ­åº¦å€¼æ’åºï¼Œç”Ÿæˆå…¬å…±çƒ­é—¨æ¨¡æ¿ï¼Œä½œä¸ºæ¯ä¸ªç”¨æˆ·å•ç‹¬çƒ­é—¨åˆ—è¡¨çš„åˆå§‹ã€‚ä»£ç å¦‚ä¸‹:

```python 
def get_hot_rec_list(self):
        """è·å–ç‰©æ–™çš„ç‚¹èµï¼Œæ”¶è—å’Œåˆ›å»ºæ—¶é—´ç­‰ä¿¡æ¯ï¼Œè®¡ç®—çƒ­åº¦å¹¶ç”Ÿæˆçƒ­åº¦æ¨èåˆ—è¡¨å­˜å…¥redis
        """
        # éå†ç‰©æ–™æ± é‡Œé¢çš„æ‰€æœ‰æ–‡ç« 
        for item in self.feature_protrail_collection.find():
            news_id = item['news_id']
            news_cate = item['cate']
            news_ctime = item['ctime']
            news_likes_num = item['likes']
            news_collections_num = item['collections']
            news_read_num = item['read_num']
            news_hot_value = item['hot_value']

            #print(news_id, news_cate, news_ctime, news_likes_num, news_collections_num, news_read_num, news_hot_value)

            # æ—¶é—´è½¬æ¢ä¸è®¡ç®—æ—¶é—´å·®   å‰æè¦ä¿è¯å½“å‰æ—¶é—´å¤§äºæ–°é—»åˆ›å»ºæ—¶é—´ï¼Œç›®å‰æ²¡æœ‰æ•æ‰å¼‚å¸¸
            news_ctime_standard = datetime.strptime(news_ctime, "%Y-%m-%d %H:%M")
            cur_time_standard = datetime.now()
            time_day_diff = (cur_time_standard - news_ctime_standard).days
            time_hour_diff = (cur_time_standard - news_ctime_standard).seconds / 3600

            # åªè¦æœ€è¿‘3å¤©çš„å†…å®¹
            if time_day_diff > 3:
                continue
            
            # è®¡ç®—çƒ­åº¦åˆ†ï¼Œè¿™é‡Œä½¿ç”¨é­”æ–¹ç§€çƒ­åº¦å…¬å¼ï¼Œ å¯ä»¥è¿›è¡Œè°ƒæ•´, read_num ä¸Šä¸€æ¬¡çš„ hot_value  ä¸Šä¸€æ¬¡çš„hot_valueç”¨åŠ ï¼Ÿ  å› ä¸ºlike_numè¿™äº›ä¹Ÿéƒ½æ˜¯ç´¯åŠ ä¸Šæ¥çš„ï¼Œ æ‰€ä»¥è¿™é‡Œè®¡ç®—çš„å¹¶ä¸æ˜¯å¢å€¼ï¼Œè€Œæ˜¯å®æ—¶çƒ­åº¦å§
            # news_hot_value = (news_likes_num * 6 + news_collections_num * 3 + news_read_num * 1) * 10 / (time_hour_diff+1)**1.2
            # 72 è¡¨ç¤ºçš„æ˜¯3å¤©ï¼Œ
            news_hot_value = (news_likes_num * 0.6 + news_collections_num * 0.3 + news_read_num * 0.1) * 10 / (1 + time_hour_diff / 72) 

            #print(news_likes_num, news_collections_num, time_hour_diff)

            # æ›´æ–°ç‰©æ–™æ± çš„æ–‡ç« hot_value
            item['hot_value'] = news_hot_value
            self.feature_protrail_collection.update({'news_id':news_id}, item)

            #print("news_hot_value: ", news_hot_value)

            # ä¿å­˜åˆ°redisä¸­
            self.reclist_redis.zadd('hot_list', {'{}_{}'.format(news_cate, news_id): news_hot_value}, nx=True)
```

### æ¨èé¡µåˆ—è¡¨

å½“ç”¨æˆ·è¿›å…¥ç³»ç»Ÿï¼Œ æ˜ å…¥çœ¼å¸˜çš„å°±æ˜¯æ¨èé¡µï¼Œ onlineæœåŠ¡ä¼šç»™å½“å‰ç”¨æˆ·è·å–æ¨èé¡µåˆ—è¡¨ï¼Œ è¿™ä¸ªåˆ—è¡¨åŒæ ·æ˜¯ç”¨æˆ·è¿›å…¥çš„æ—¶å€™ï¼Œç¦»çº¿äº‹å…ˆç”Ÿæˆç¼“å­˜åˆ°redisä¸­ã€‚

æ¨èé¡µï¼Œä¹Ÿæ­£æ˜¯æˆ‘ä»¬æ¨èç³»ç»Ÿå‘æŒ¥æ•ˆç”¨çš„éƒ¨åˆ†ï¼Œå¯¹äºæ¯ä¸ªç”¨æˆ·ï¼Œæˆ‘ä»¬ä¼šç”Ÿæˆä¸åŒçš„æ¨èé¡µé¢ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬æ‰€çŸ¥æ‚‰çš„"åƒäººåƒé¢"ï¼Œå¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹ï¼Ÿ å°±éœ€è¦å€ŸåŠ©å·²ç»å­˜å¥½çš„ç”¨æˆ·ç”»åƒå’Œç‰©å“ç”»åƒï¼Œåˆ¶ä½œç‰¹å¾ï¼Œç„¶åé€šè¿‡æ¨¡å‹é¢„æµ‹æ’åºï¼Œåšåˆ°æ‰€è°“çš„ä¸ªæ€§åŒ–ã€‚  å½“ç„¶ï¼Œå¯¹äºä¸€ä¸ªæ–°æ¥çš„ç”¨æˆ·ï¼Œç”±äºæˆ‘ä»¬äº‹å…ˆæ²¡æœ‰å­˜å‚¨å¥½ç”¨æˆ·ç”»åƒï¼Œè¿™å°±æ„å‘³ç€å¯èƒ½æ²¡æ³•èµ°ä¸ªæ€§åŒ–æ¨èæµç¨‹ï¼Œè¿™é‡Œæˆ‘ä»¬å½“åšå†·å¯åŠ¨å¤„ç†ã€‚æ‰€ä»¥è¿™å—åˆ†æˆäº†å†·å¯åŠ¨å’Œä¸ªæ€§åŒ–æ¨èä¸¤å—è¿›è¡Œæ¢³ç†ï¼Œé€»è¾‘å¦‚ä¸‹:

- å†·å¯åŠ¨: å†·å¯åŠ¨ä¸»è¦æ˜¯é’ˆå¯¹æ–°ç”¨æˆ·ï¼Œæˆ‘ä»¬æ²¡æœ‰å¤ªè¯¦ç»†çš„ç”¨æˆ·ç”»åƒä¿¡æ¯ï¼Œæ‰€ä»¥åªèƒ½é€šè¿‡ä¸€äº›ç²—ç•¥çš„ä¿¡æ¯ï¼Œæ¯”å¦‚å¹´é¾„ï¼Œæ€§åˆ«(ç”¨æˆ·æ³¨å†Œæ—¶ä¼šè·å–åˆ°)ç­‰ï¼Œè·å–åˆ°ä¸€äº›å¤§ç±»åˆ«ä¸‹çš„æ–‡ç« (é€‚åˆè¯¥å¹´é¾„ï¼Œè¯¥æ€§åˆ«çœ‹çš„æ–‡ç« )ï¼Œç„¶åå†æ ¹æ®æ–‡ç« çš„çƒ­åº¦ä¿¡æ¯ï¼Œç»™æ–°ç”¨æˆ·ç”Ÿæˆä¸€ä»½å†·å¯åŠ¨æ¨èåˆ—è¡¨ã€‚ å½“ç„¶è¿™é‡Œåªæ˜¯è¯´äº†ä¸€ç§ç®€å•çš„æ–¹å¼ï¼Œå†·å¯åŠ¨å…¶å®ä¹Ÿæ˜¯ä¸€ç§æ¯”è¾ƒå¤æ‚çš„åœºæ™¯ï¼Œæ„Ÿå…´è¶£åŒå­¦å¯ä»¥æŸ¥é˜…ä¸€äº›å…¶ä»–èµ„æ–™ï¼Œä¹Ÿæ¬¢è¿å’Œæˆ‘ä»¬è®¨è®ºã€‚è¿™é‡Œæ˜¯æ ¹æ®ç”¨æˆ·çš„å¹´é¾„å’Œæ€§åˆ«è‡ªå®šä¹‰åˆ†æˆäº†å››ç±»äººç¾¤

  ```python
  def generate_cold_start_news_list_to_redis_for_register_user(self):
          """ç»™å·²ç»æ³¨å†Œçš„ç”¨æˆ·åˆ¶ä½œå†·å¯åŠ¨æ–°é—»åˆ—è¡¨
          """
          for user_info in self.register_user_sess.query(RegisterUser).all():
              if int(user_info.age) < 23 and user_info.gender == "female":
                  redis_key = "cold_start_group:{}".format(str(1))
                  self.copy_redis_sorted_set(user_info.userid, redis_key)
              elif int(user_info.age) >= 23 and user_info.gender == "female":
                  redis_key = "cold_start_group:{}".format(str(2))
                  self.copy_redis_sorted_set(user_info.userid, redis_key)
              elif int(user_info.age) < 23 and user_info.gender == "male":
                  redis_key = "cold_start_group:{}".format(str(3))
                  self.copy_redis_sorted_set(user_info.userid, redis_key)
              elif int(user_info.age) >= 23 and user_info.gender == "male":
                  redis_key = "cold_start_group:{}".format(str(4))
                  self.copy_redis_sorted_set(user_info.userid, redis_key)
              else:
                  pass 
          print("generate_cold_start_news_list_to_redis_for_register_user.")
  ```

- ä¸ªæ€§åŒ–: ä¸ªæ€§åŒ–æ¨èä¸»è¦æ˜¯é’ˆå¯¹è€ç”¨æˆ·ï¼Œæˆ‘ä»¬é€šè¿‡æ­£å¸¸æ¨èæµç¨‹ï¼Œ æ•æ‰å…¶å…´è¶£çˆ±å¥½ï¼Œåšåˆ°ä¸ªæ€§æ¨èï¼Œä¼˜åŒ–ç”¨æˆ·ä½“éªŒã€‚ æ‰€ä»¥è¿™å—èµ°æ­£å¸¸æ¨èæµç¨‹ï¼Œæ¯”å¦‚æˆ‘ä»¬æ‰€ç†ŸçŸ¥çš„å¬å›â†’æ’åºâ†’é‡æ’â†’ä¸ªæ€§åŒ–åˆ—è¡¨ç”Ÿæˆï¼Œ å¬å›çš„ç›®çš„æ˜¯æ ¹æ®ç”¨æˆ·éƒ¨åˆ†ç‰¹å¾ï¼Œä»æµ·é‡ç‰©å“åº“ï¼Œå¿«é€Ÿæ‰¾åˆ°å°éƒ¨åˆ†ç”¨æˆ·æ½œåœ¨æ„Ÿå…´è¶£çš„ç‰©å“äº¤ç»™ç²¾æ’ï¼Œé‡ç‚¹å¼ºè°ƒå¿«ï¼Œç²¾æ’ä¸»è¦æ˜¯èå…¥æ›´å¤šç‰¹å¾ï¼Œä½¿ç”¨å¤æ‚æ¨¡å‹ï¼Œæ¥åšä¸ªæ€§åŒ–æ¨èï¼Œå¼ºè°ƒå‡†ã€‚ è€Œé‡æ’ä¾§ï¼Œä¸»è¦æ˜¯ç»“åˆç²¾æ’çš„ç»“æœï¼Œå†åŠ ä¸Šå„ç§ä¸šåŠ¡ç­–ç•¥ï¼Œæ¯”å¦‚å»é‡ï¼Œæ’å…¥ï¼Œæ‰“æ•£ï¼Œå¤šæ ·æ€§ä¿è¯ç­‰ï¼Œä¸»è¦æ˜¯æŠ€æœ¯äº§å“ç­–ç•¥ä¸»å¯¼æˆ–æ”¹å–„ç”¨æˆ·ä½“éªŒçš„ã€‚ æ‰€ä»¥è¿™å‡ ä¸ªç¯èŠ‚ç»„åˆèµ·æ¥ï¼Œä»¥"è¿…é›·ä¸åŠæ©è€³æ¼æ–—ä¹‹åŠ¿"ï¼Œç»„æˆäº†ä¸ªæ€§åŒ–æ¨èç³»ç»Ÿçš„æ•´ä¸ªæ¶æ„ã€‚ç”±äºè¿™æ˜¯æ¨èçš„é‡ç‚¹ç¯èŠ‚ï¼Œ æ¯ä¸ªæ¨¡å—éƒ½æœ‰éå¸¸ä¸°å¯Œçš„çŸ¥è¯†ç»†èŠ‚ï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šä»‹ç»äº†ï¼Œåé¢æœ‰æœºä¼šçš„è¯å•ç‹¬æ•´ç†ã€‚

æ‰€ä»¥ï¼Œ æ¨èé¡µåˆ—è¡¨ç”Ÿæˆè¿‡ç¨‹æ€»ç»“èµ·æ¥ï¼Œ é¦–å…ˆå…ˆæ ¹æ®ç”¨æˆ·çš„ç±»å‹åˆ†æˆä¸¤æ³¢ï¼Œ å¦‚æœæ˜¯æ–°ç”¨æˆ·ï¼Œ å°±èµ°å†·å¯åŠ¨æ¨èæµç¨‹ï¼Œé€šè¿‡ç”¨æˆ·ç²—ç•¥ä¿¡æ¯ï¼Œç»™ç”¨æˆ·ç”Ÿæˆä¸€ä»½å†·å¯åŠ¨æ¨èåˆ—è¡¨ã€‚ å¦‚æœæ˜¯è€ç”¨æˆ·ï¼Œ å°±èµ°ä¸ªæ€§åŒ–æ¨èæµç¨‹ï¼Œ é€šè¿‡å¬å›â†’æ’åºâ†’é‡æ’ç­‰ï¼Œç»™è€ç”¨æˆ·ç”Ÿæˆä¸€ä»½ä¸ªæ€§åŒ–åˆ—è¡¨ã€‚æœ€ç»ˆéƒ½å­˜å‚¨åˆ°Redisä¸­ã€‚

è‡³æ­¤ï¼Œ offlineæµç¨‹ç»“æŸï¼Œ é€šè¿‡offlineï¼Œ å¯¹äºæ¯ä¸ªç”¨æˆ·ï¼Œ æˆ‘ä»¬ç¦»çº¿ç”Ÿæˆå¥½çƒ­é—¨é¡µåˆ—è¡¨ï¼Œ æ¨èé¡µåˆ—è¡¨ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹onlineã€‚

# Online

Onlineæ˜¯ä¸ºç”¨æˆ·åœ¨ä½¿ç”¨APPæˆ–è€…ç³»ç»Ÿçš„è¿‡ç¨‹ä¸­è§¦å‘çš„è¡Œä¸ºæä¾›ä¸€ç³»åˆ—æœåŠ¡ï¼Œå½“ç”¨æˆ·åˆšè¿›å…¥ç³»ç»Ÿçš„æ—¶å€™ï¼Œ ä¼šè¿›å…¥æ–°é—»çš„æ¨èé¡µé¢ï¼Œæ­¤æ—¶ç³»ç»Ÿä¼šä¸ºè¯¥ç”¨æˆ·è·å–æ¨èé¡µæ–‡ç« å¹¶è¿›è¡Œå±•ç¤ºï¼Œå½“ç”¨æˆ·è¿›å…¥çƒ­é—¨é¡µï¼Œ ç³»ç»Ÿå°±ä¼šä¸ºè¯¥ç”¨æˆ·è·å–çƒ­é—¨é¡µåˆ—è¡¨å¹¶è¿›è¡Œå±•ç¤ºï¼Œ ä¸‹é¢ä¸»è¦ä»‹ç»è¿™ä¸¤å—çº¿ä¸Šè·å–è¿‡ç¨‹ä¸­çš„ä¸€äº›ç»†èŠ‚ã€‚

- è·å–æ¨èé¡µåˆ—è¡¨ï¼š è¿™ä¸ªæœåŠ¡åœ¨ç”¨æˆ·åˆšè¿›å…¥ç³»ç»Ÿï¼Œä»¥åŠåœ¨æ¨èé¡µä¸­æµè§ˆæ–‡ç« åˆ·æ–°ä¸‹æ‹‰è¿‡ç¨‹ä¸­è¿›è¡Œè§¦å‘ï¼Œå½“ç³»ç»Ÿè§¦å‘è¯¥æœåŠ¡çš„æ—¶å€™ï¼Œ é¦–å…ˆä¼šåˆ¤æ–­è¯¥ç”¨æˆ·æ˜¯æ–°ç”¨æˆ·è¿˜æ˜¯è€ç”¨æˆ·
  - å¦‚æœæ˜¯æ–°ç”¨æˆ·ï¼Œ å°±ä»ç¦»çº¿å­˜å‚¨å¥½çš„å†·å¯åŠ¨åˆ—è¡¨ä¸­è¯»å–æ¨èåˆ—è¡¨ï¼Œ é€‰æ‹©æŒ‡å®šçš„æ•°ç›®(æ¯”å¦‚ä¸€æ¬¡è§¦å‘ç»™ç”¨æˆ·æ¨è10ç¯‡)çš„æ–‡ç« æ¨èï¼Œä½†æ¨èä¹‹å‰ï¼Œéœ€è¦å»é™¤å·²æ›å…‰çš„æ–‡ç« (é¿å…é‡å¤æ›å…‰ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ)ï¼Œæ‰€ä»¥å¯¹äºæ¯ä¸ªç”¨æˆ·ï¼Œæˆ‘ä»¬è¿˜ä¼šè®°å½•ä¸€ä»½å·²æ›å…‰åˆ—è¡¨ï¼Œæ–¹ä¾¿æˆ‘ä»¬å»é‡ï¼Œ åŒæ—¶ï¼Œå½“æ‰¹æ–‡ç« æ›å…‰å‡ºå»ï¼Œè¿˜è¦å³ä½¿æ›´æ–°æˆ‘ä»¬çš„æ›å…‰åˆ—è¡¨ã€‚
  - å¦‚æœæ˜¯è€ç”¨æˆ·ï¼Œ å°±ä»ç¦»çº¿å­˜å‚¨å¥½çš„ä¸ªæ€§åŒ–æ¨èåˆ—è¡¨ä¸­è¯»å–ï¼Œ å’Œä¸Šé¢ä¸€æ ·ï¼Œ é€‰æ‹©æŒ‡å®šæ•°ç›®çš„æ–‡ç« ï¼Œå»æ‰æ›å…‰ï¼Œç”Ÿæˆæœ€ç»ˆæ¨èåˆ—è¡¨ï¼ŒåŒæ—¶æ›´æ–°ç”¨æˆ·æ›å…‰è®°å½•ã€‚
  - è¿™æ ·å°±å®Œæˆäº†æ¨èé¡µçš„æ¨èæœåŠ¡ã€‚
  
- è·å–çƒ­é—¨é¡µåˆ—è¡¨: è¿™ä¸ªæœåŠ¡æ˜¯ç”¨æˆ·ç‚¹å‡»çƒ­é—¨é¡µï¼Œä»¥åŠåœ¨çƒ­é—¨é¡µä¸­æµè§ˆæ–‡ç« åˆ·æ–°ä¸‹æ¥è¿‡ç¨‹ä¸­è¿›è¡Œè§¦å‘ï¼Œå½“è¯¥æœåŠ¡è§¦å‘çš„æ—¶å€™ï¼Œä¾ç„¶ä¼šåˆ¤æ–­æ–°ç”¨æˆ·å’Œè€ç”¨æˆ·
  - å¦‚æœæ˜¯æ–°ç”¨æˆ·ï¼Œ éœ€è¦ä»ç¦»çº¿å­˜å‚¨å¥½çš„å…¬å…±å†·å¯åŠ¨æ¨¡æ¿ä¸­ä¸ºè¯¥ç”¨æˆ·ç”Ÿæˆä¸€ä»½çƒ­é—¨é¡µåˆ—è¡¨ï¼Œç„¶åè·å–ï¼Œé€‰æ‹©æŒ‡å®šæ•°ç›®æ–‡ç« æ¨èï¼Œå’Œä¸Šé¢ä¸€æ ·ï¼Œå»æ›å…‰ï¼Œç”Ÿæˆæœ€ç»ˆæ¨èåˆ—è¡¨ï¼Œæ›´æ–°æ›å…‰è®°å½•ã€‚
  - å¦‚æœæ˜¯è€ç”¨æˆ·ï¼Œ ä»ç¦»çº¿å­˜å‚¨å¥½çš„è¯¥ç”¨æˆ·çƒ­é—¨åˆ—è¡¨ä¸­è¯»å–ï¼Œé€‰æ‹©æŒ‡å®šæ•°ç›®æ–‡ç« æ¨èï¼Œå»æ›å…‰ï¼Œç”Ÿæˆæœ€ç»ˆæ¨èåˆ—è¡¨ï¼Œæ›´æ–°æ›å…‰è®°å½•ã€‚
  - è¿™æ ·å°±å®Œæˆäº†çƒ­é—¨é¡µçš„æ¨èæœåŠ¡ã€‚
  
  ä»£ç å¦‚ä¸‹:
  
  ```python
  def get_hot_list(self, user_id):
          """çƒ­é—¨é¡µåˆ—è¡¨ç»“æœ"""
          hot_list_key_prefix = "user_id_hot_list:"
          hot_list_user_key = hot_list_key_prefix + str(user_id)
  
          user_exposure_prefix = "user_exposure:"
          user_exposure_key = user_exposure_prefix + str(user_id)
  
          # å½“æ•°æ®åº“ä¸­æ²¡æœ‰è¿™ä¸ªç”¨æˆ·çš„æ•°æ®ï¼Œå°±ä»çƒ­é—¨åˆ—è¡¨ä¸­æ‹·è´ä¸€ä»½ 
          if self.reclist_redis_db.exists(hot_list_user_key) == 0: # å­˜åœ¨è¿”å›1ï¼Œä¸å­˜åœ¨è¿”å›0
              print("copy a hot_list for {}".format(hot_list_user_key))
              # ç»™å½“å‰ç”¨æˆ·é‡æ–°ç”Ÿæˆä¸€ä¸ªhoté¡µæ¨èåˆ—è¡¨ï¼Œ ä¹Ÿå°±æ˜¯æŠŠhot_listé‡Œé¢çš„åˆ—è¡¨å¤åˆ¶ä¸€ä»½ç»™å½“å‰userï¼Œ keyæ¢æˆuser_id
              self.reclist_redis_db.zunionstore(hot_list_user_key, ["hot_list"])
  
          # ä¸€é¡µé»˜è®¤10ä¸ªitem, ä½†è¿™é‡Œå€™é€‰20æ¡ï¼Œå› ä¸ºæœ‰å¯èƒ½æœ‰çš„åœ¨æ¨èé¡µæ›å…‰è¿‡
          article_num = 200
  
          # è¿”å›çš„æ˜¯ä¸€ä¸ªnews_idåˆ—è¡¨   zrevrangeæ’åºåˆ†å€¼ä»å¤§åˆ°å°
          candiate_id_list = self.reclist_redis_db.zrevrange(hot_list_user_key, 0, article_num-1)
  
          if len(candiate_id_list) > 0:
              # æ ¹æ®news_idè·å–æ–°é—»çš„å…·ä½“å†…å®¹ï¼Œå¹¶è¿”å›ä¸€ä¸ªåˆ—è¡¨ï¼Œåˆ—è¡¨ä¸­çš„å…ƒç´ æ˜¯æŒ‰ç…§é¡ºåºå±•ç¤ºçš„æ–°é—»ä¿¡æ¯å­—å…¸
              news_info_list = []
              selected_news = []   # è®°å½•çœŸæ­£è¢«é€‰äº†çš„
              cou = 0
  
              # æ›å…‰åˆ—è¡¨
              print("self.reclist_redis_db.exists(key)",self.exposure_redis_db.exists(user_exposure_key))
              if self.exposure_redis_db.exists(user_exposure_key) > 0:
                  exposure_list = self.exposure_redis_db.smembers(user_exposure_key)
                  news_expose_list = set(map(lambda x: x.split(':')[0], exposure_list))
              else:
                  news_expose_list = set()
  
              for i in range(len(candiate_id_list)):
                  candiate = candiate_id_list[i]
                  news_id = candiate.split('_')[1]
  
                  # å»é‡æ›å…‰è¿‡çš„ï¼ŒåŒ…æ‹¬åœ¨æ¨èé¡µä»¥åŠhoté¡µ
                  if news_id in news_expose_list:
                      continue
  
                  # TODO æœ‰äº›æ–°é—»å¯èƒ½è·å–ä¸åˆ°é™æ€çš„ä¿¡æ¯ï¼Œè¿™é‡Œåº”è¯¥æœ‰ä»€ä¹ˆbug
                  # bug åŸå› æ˜¯ï¼Œjson.loads() redisä¸­çš„æ•°æ®ä¼šæŠ¥é”™ï¼Œéœ€è¦å¯¹redisä¸­çš„æ•°æ®è¿›è¡Œå¤„ç†
                  # å¯ä»¥åœ¨ç‰©æ–™å¤„ç†çš„æ—¶å€™è¿‡æ»¤ä¸€éï¼Œjsonæ— æ³•loadçš„æ–°é—»
                  try:
                      news_info_dict = self.get_news_detail(news_id)
                  except Exception as e:
                      with open("/home/recsys/news_rec_server/logs/news_bad_cases.log", "a+") as f:
                          f.write(news_id + "\n")
                          print("there are not news detail info for {}".format(news_id))
                      continue
                  # éœ€è¦ç¡®è®¤ä¸€ä¸‹å‰ç«¯æ¥æ”¶çš„jsonï¼Œkeyéœ€è¦æ˜¯å•å¼•å·è¿˜æ˜¯åŒå¼•å·
                  news_info_list.append(news_info_dict)
                  news_expose_list.add(news_id)
                  # æ³¨æ„ï¼ŒåŸæ•°çš„keyä¸­æ˜¯åŒ…å«äº†ç±»åˆ«ä¿¡æ¯çš„
                  selected_news.append(candiate)
                  cou += 1
                  if cou == 10:
                      break
              
              if len(selected_news) > 0:
                  # æ‰‹åŠ¨åˆ é™¤è¯»å–å‡ºæ¥çš„ç¼“å­˜ç»“æœ, è¿™ä¸ªå¾ˆå…³é”®, è¿”å›è¢«åˆ é™¤çš„å…ƒç´ æ•°é‡ï¼Œç”¨æ¥æ£€æµ‹æ˜¯å¦è¢«çœŸçš„è¢«åˆ é™¤äº†
                  removed_num = self.reclist_redis_db.zrem(hot_list_user_key, *selected_news)
                  print("the numbers of be removed:", removed_num)
  
              # æ›å…‰é‡æ–°è½è¡¨
              self._save_user_exposure(user_id,news_expose_list)
              return news_info_list 
          else:
              #TODO ä¸´æ—¶è¿™ä¹ˆåšï¼Œè¿™ä¹ˆåšä¸å¤ªå¥½
              self.reclist_redis_db.zunionstore(hot_list_user_key, ["hot_list"])
              print("copy a hot_list for {}".format(hot_list_user_key))
              # å¦‚æœæ˜¯æŠŠæ‰€æœ‰å†…å®¹éƒ½åˆ·å®Œäº†å†é‡æ–°æ‹·è´çš„æ•°æ®ï¼Œè¿˜å¾—è®°å¾—æŠŠä»Šå¤©çš„æ›å…‰æ•°æ®ç»™æ¸…é™¤äº†
              self.exposure_redis_db.delete(user_exposure_key)
              return  self.get_hot_list(user_id)
  ```

è‡³æ­¤ï¼Œ Onlineéƒ¨åˆ†çš„æ¨èç›¸å…³æµç¨‹ç»“æŸï¼Œ Onlineçš„æ¨èæµç¨‹ï¼Œä¸»è¦ä¸ºç”¨æˆ·çš„æ¨èé¡µä»¥åŠçƒ­é—¨é¡µäº§ç”Ÿæ¨èåˆ—è¡¨è¿›è¡ŒæœåŠ¡ã€‚

